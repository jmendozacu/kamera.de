<?php
/**
 * This file was generated by the ConvertToLegacy class in bronto-legacy.
 * The purpose of the conversion was to maintain PSR-0 compliance while
 * the main development focuses on modern styles found in PSR-4.
 *
 * For the original:
 * @see src/Bronto/Magento/Coupon/Manager.php
 */

class Brontosoftware_Magento_Coupon_Manager extends Brontosoftware_Magento_Core_Config_ContainerAbstract implements Brontosoftware_Magento_Coupon_ManagerInterface
{
    protected $_data;
    protected $_writer;
    protected $_rules;
    protected $_config;

    /**
     * @param Brontosoftware_Magento_Core_Config_ScopedInterface $config,
     * @param Brontosoftware_Magento_Core_Config_FactoryInterface $data,
     * @param Brontosoftware_Magento_Core_Sales_RuleManagerInterface $rules
     */
    public function __construct(
        Brontosoftware_Magento_Core_Config_ScopedInterface $config,
        Brontosoftware_Magento_Core_Config_FactoryInterface $data,
        Brontosoftware_Magento_Core_Config_ManagerInterface $writer,
        Brontosoftware_Magento_Core_Sales_RuleManagerInterface $rules
    ) {
        parent::__construct($config);
        $this->_data = $data;
        $this->_rules = $rules;
        $this->_writer = $writer;
    }

    /**
     * @see parent
     */
    public function getAll(Brontosoftware_Magento_Connector_RegistrationInterface $registration)
    {
        $scopeType = $registration->getScope();
        if ($scopeType != 'default') {
            $scopeType .= 's';
        }
        $data = $this->_data->getCollection()
            ->addFieldToFilter('path', array('like' => self::XML_PATH_OBJECT_PATH))
            ->addFieldToFilter('scope', array('eq' => $scopeType))
            ->addFieldToFilter('scope_id', array('eq' => $registration->getScopeId()));
        $generators = array();
        foreach ($data as $config) {
            $object = unserialize($config->getValue());
            if (!$this->_validate($object)) {
                continue;
            }
            $object['scope'] = $config->getScope();
            $object['scopeId'] = $config->getScopeId();
            $generators[] = $object;
        }
        return $generators;
    }

    /**
     * @see parent
     */
    public function getById($generatorId, $force = false)
    {
        $objectId = str_replace('%', $this->_safeId($generatorId), self::XML_PATH_OBJECT_PATH);
        $data = $this->_data->getCollection()
            ->addFieldToFilter('path', array('eq' => $objectId));
        $object = null;
        $config = null;
        foreach ($data as $config) {
            $object = $config->getValue();
        }
        if (empty($object)) {
            return null;
        }
        $object = unserialize($object);
        if (!$this->_validate($object, $force)) {
            return null;
        }
        $object['scope'] = $config->getScope();
        $object['scopeId'] = $config->getScopeId();
        return $object;
    }

    /**
     * @see parent
     */
    public function save($generatorId, $generator, Brontosoftware_Magento_Connector_RegistrationInterface $registration)
    {
        $objectId = str_replace('%', $this->_safeId($generatorId), self::XML_PATH_OBJECT_PATH);
        $this->_writer->save($objectId, serialize($generator), $registration->getScope(), $registration->getScopeId());
    }

    /**
     * @see parent
     */
    public function acquireCoupons($generator, $amount = null)
    {
        if (!$this->_validate($generator)) {
            return array();
        }
        if (is_null($amount)) {
            $amount = $generator['amount'];
        }
        return $this->_rules->acquireCoupons(array(
            'qty' => $amount,
            'rule_id' => $generator['ruleId'],
            'format' => $generator['format'],
            'length' => $generator['length'],
            'dash' => array_key_exists('dashInterval', $generator) ? $generator['dashInterval'] : 0,
            'prefix' => array_key_exists('prefix', $generator) ? $generator['prefix'] : null,
            'suffix' => array_key_exists('suffix', $generator) ? $generator['suffix'] : null
        ));
    }

    /**
     * @see parent
     */
    public function acquireCoupon($generatorId)
    {
        $generator = $this->getById($generatorId);
        if (empty($generator)) {
            return '';
        }
        $coupons = $this->acquireCoupons($generator, 1);
        if (empty($coupons)) {
            return '';
        }
        return $coupons[0];
    }

    /**
     * @see parent
     */
    public function getReplenishablePoolIds(Brontosoftware_Magento_Connector_RegistrationInterface $registration)
    {
        $poolIds = array();
        foreach ($this->getAll($registration) as $generator) {
            if (array_key_exists('integration', $generator) && $generator['integration']) {
                $poolIds[] = $generator['id'];
            }
        }
        return $poolIds;
    }

    /**
     * Validates the generator
     *
     * @param array $generator
     * @param boolean $force
     * @return boolean
     */
    protected function _validate($generator, $force = false)
    {
        if (!$force && (!array_key_exists('enabled', $generator) || !$generator['enabled'])) {
            return false;
        }

        if (!empty($generator['endDate'])) {
            $endDate = strtotime($generator['endDate']);
            if ($endDate < time()) {
                return false;
            }
        }

        return true;
    }
}
