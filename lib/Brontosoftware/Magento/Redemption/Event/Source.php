<?php
/**
 * This file was generated by the ConvertToLegacy class in bronto-legacy.
 * The purpose of the conversion was to maintain PSR-0 compliance while
 * the main development focuses on modern styles found in PSR-4.
 *
 * For the original:
 * @see src/Bronto/Magento/Redemption/Event/Source.php
 */

class Brontosoftware_Magento_Redemption_Event_Source implements Brontosoftware_Magento_Connector_Event_SourceInterface
{
    protected $_settings;

    /**
     * @param Brontosoftware_Magento_Order_SettingsInterface $settings
     */
    public function __construct(
        Brontosoftware_Magento_Order_SettingsInterface $settings
    ) {
        $this->_settings = $settings;
    }

    /**
     * @see parent
     */
    public function getEventType()
    {
        return 'couponManager';
    }

    /**
     * @see parent
     */
    public function action($order)
    {
        $couponCode = $order->getCouponCode();
        return !empty($couponCode) ? 'add' : '';
    }

    /**
     * @see parent
     */
    public function transform($order)
    {
        $isBase = $this->_settings->isBasePrice('store', $order->getStoreId());
        return array(
            'redemptions' => array(
                array(
                    'email' => $order->getCustomerEmail(),
                    'coupon' => $order->getCouponCode(),
                    'orderId' => $order->getIncrementId(),
                    'orderSubtotal' => $isBase ?
                        $order->getBaseSubtotal() :
                        $order->getSubtotal(),
                    'orderDiscount' => $isBase ?
                        $order->getBaseDiscountAmount() :
                        $order->getDiscountAmount(),
                    'date' => date('c', strtotime($order->getCreatedAt()))
                )
            )
        );
    }
}
