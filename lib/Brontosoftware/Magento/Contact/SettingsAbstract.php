<?php
/**
 * This file was generated by the ConvertToLegacy class in bronto-legacy.
 * The purpose of the conversion was to maintain PSR-0 compliance while
 * the main development focuses on modern styles found in PSR-4.
 *
 * For the original:
 * @see src/Bronto/Magento/Contact/SettingsAbstract.php
 */

abstract class Brontosoftware_Magento_Contact_SettingsAbstract extends Brontosoftware_Magento_Core_Config_ContainerAbstract implements Brontosoftware_Magento_Contact_SettingsInterface
{
    const EVENT_PREFIX = "brontosoftware_contact_extra_";

    protected static $_attributeKeys = array(
        'attributes',
        'shipping_address_attributes',
        'billing_address_attributes'
    );

    protected $_data;
    protected $_eventManager;
    protected $_storeManager;
    protected $_groupCache;

    /**
     * @param Brontosoftware_Magento_Core_Store_ManagerInterface $storeManager
     * @param Brontosoftware_Magento_Core_Customer_GroupCacheInterface $groupCache
     * @param Brontosoftware_Magento_Core_Config_FactoryInterface $data
     * @param Brontosoftware_Magento_Core_Config_ScopedInterface $config
     * @param Brontosoftware_Magento_Core_Event_ManagerInterface $eventManager
     */
    public function __construct(
        Brontosoftware_Magento_Core_Store_ManagerInterface $storeManager,
        Brontosoftware_Magento_Core_Customer_GroupCacheInterface $groupCache,
        Brontosoftware_Magento_Core_Config_FactoryInterface $data,
        Brontosoftware_Magento_Core_Config_ScopedInterface $config,
        Brontosoftware_Magento_Core_Event_ManagerInterface $eventManager
    ) {
        parent::__construct($config);
        $this->_data = $data;
        $this->_eventManager = $eventManager;
        $this->_groupCache = $groupCache;
        $this->_storeManager = $storeManager;
    }

    /**
     * @see parent
     */
    public function isEnabled($scopeType = 'default', $scopeCode = null)
    {
        return $this->_config->isSetFlag(self::XML_PATH_ENABLED, $scopeType, $scopeCode);
    }

    /**
     * @see parent
     */
    public function isSkipEmpty($scopeType = 'default', $scopeCode = null)
    {
        return $this->_config->isSetFlag(self::XML_PATH_SKIP_EMPTY, $scopeType, $scopeCode);
    }

    /**
     * @see parent
     */
    public function getGuestOrderToggle($scopeType = 'default', $scopeCode = null)
    {
        return $this->_config->getValue(self::XML_PATH_GUEST_ORDER, $scopeType, $scopeCode);
    }

    /**
     * @see parent
     */
    public function getAttributeFilters()
    {
        $attributes = array();
        $attributes[] = array(
            'increment_id',
            'updated_at',
            'store_id',
            'entity_id',
            'attribute_set_id',
            'entity_type_id',
            'password_hash',
            'default_billing',
            'default_shipping',
            'email',
            'confirmation',
            'reward_update_notification',
            'reward_warning_notification',
            'disable_auto_group_change'
        );
        $addressFilters = array(
            'region',
            'vat_id',
            'vat_is_valid',
            'vat_request_id',
            'vat_request_date',
            'vat_request_success',
        );
        $attributes[] = $addressFilters;
        $attributes[] = $addressFilters;
        return array_combine(self::$_attributeKeys, $attributes);
    }

    /**
     * @see parent
     */
    public function getFieldsForModel($object, $storeId, $type = 'contact')
    {
        $fields = array();
        $skipEmpty = $this->isSkipEmpty('store', $storeId);
        foreach ($this->getAttributesToModel($type, $storeId) as $key => $func) {
            $attributes = $this->_savedAttributes($key, $storeId);
            if (!empty($attributes)) {
                $container = new Brontosoftware_Magento_Core_DataObject(array(
                    'extra' => array(),
                    'attributes' => $attributes
                ));
                $this->_eventManager->dispatch(self::EVENT_PREFIX . $type . '_'. $key, array(
                    $type => $object,
                    'storeId' => $storeId,
                    'container' => $container
                ));
                $extra = $container->getExtra();
                $dataModel = call_user_func($func, $object, array_keys($attributes));
                if ($dataModel) {
                    foreach ($attributes as $code => $brontoId) {
                        $skipAttrCheck = array_key_exists($code, $extra);
                        if ($skipAttrCheck) {
                            $value = $extra[$code];
                        } else {
                            $value = $dataModel->getData($code);
                        }
                        if ($skipEmpty && (is_null($value) || $value === '')) {
                            continue;
                        }
                        $fields[] = array(
                            'fieldId' => $brontoId,
                            'content' => $this->_attributeData($value, $dataModel, $code, $skipAttrCheck)
                        );
                    }
                }
            }
        }
        return $fields;
    }

    /**
     * @see parent
     */
    public function getAttributeDisplayType($attribute)
    {
        switch ($attribute->getFrontendInput()) {
            case 'obscure':
            case 'password':
                return 'password';
            case 'radio':
            case 'select':
                return 'select';
            case 'boolean':
                return 'checkbox';
            case 'int':
            case 'integer':
            case 'numeric':
                return 'integer';
            case 'decimal':
            case 'price':
                return 'float';
            case 'date':
            case 'datetime':
                return 'date';
            case 'textarea':
                return 'textarea';
            default:
                return 'text';
        }
    }

    /**
     * Gets the model with the corresponding loader function
     *
     * @param string $contact
     * @param mixed $storeId
     * @return array
     */
    public function getAttributesToModel($type = 'contact', $storeId = null)
    {
        $attributes = array_combine(self::$_attributeKeys, array(
            array($this, $type . 'ModelLoader'),
            array($this, $type . 'ShippingModelLoader'),
            array($this, $type . 'BillingModelLoader')
        ));
        if ($type == 'order') {
            switch ($this->getGuestOrderToggle('store', $storeId)) {
                case 'shipping':
                    unset($attributes['billing_address_attributes']);
                    break;
                case 'billing':
                    unset($attributes['shipping_address_attributes']);
                    break;
                case 'none':
                    $attributes = array();
            }
        }
        return $attributes;
    }

    /**
     * Pre-loads the customer attributes from an array of codes
     *
     * @param Magento_Customer_Model_Customer $customer
     * @param array $attributes
     * @return Magento_Customer_Model_Customer
     */
    public function contactModelLoader($customer, $attributes)
    {
        $resource = $customer->getResource();
        $resource->load($customer, $customer->getId(), array_merge($attributes, array(
            'default_shipping', 'default_billing'
        )));
        return $customer;
    }

    /**
     * Pre-loads a plain object with customer attributes from an order
     *
     * @param Magento_Sales_Model_Order $order
     * @param array $attributes
     * @return Brontosoftware_Magento_Core_DataObject
     */
    public function orderModelLoader($order, $attributes)
    {
        $data = array('email' => $order->getCustomerEmail(), 'store_id' => $order->getStoreId());
        foreach ($attributes as $attributeCode) {
            $data[$attributeCode] = $order->getData('customer_' . $attributeCode);
        }
        return new Brontosoftware_Magento_Core_DataObject($data + [ 'resource' => false ]);
    }

    /**
     * Gets primary billing address for the customer
     *
     * @param Magento_Customer_Model_Customer $customer
     * @param array $attributes
     * @return Magento_Customer_Model_Resource_Address
     */
    public function contactBillingModelLoader($customer, $attributes)
    {
        $billing = $customer->getPrimaryBillingAddress();
        if (!$billing) {
            return $this->contactShippingModelLoader($customer, $attributes);
        }
        return $billing;
    }

    /**
     * Gets the billing address associated with an order
     *
     * @param Magento_Sales_Model_Order $order
     * @param array $attributes
     * @return mixed
     */
    public function orderBillingModelLoader($order, $attributes)
    {
        return $order->getBillingAddress();
    }

    /**
     * Gets primary shipping address for the customer
     *
     * @param Magento_Customer_Model_Customer $customer
     * @param array $attributes
     * @return Magento_Customer_Model_Resource_Address
     */
    public function contactShippingModelLoader($customer, $attributes)
    {
        $shipping = $customer->getPrimaryShippingAddress();
        if (!$shipping) {
            foreach ($customer->getAdditionalAddresses() as $shipping) {
                break;
            }
        }
        return $shipping;
    }

    /**
     * Gets the billing address associated with an order
     *
     * @param Magento_Sales_Model_Order $order
     * @param array $attributes
     * @return mixed
     */
    public function orderShippingModelLoader($order, $attributes)
    {
        return $order->getShippingAddress();
    }

    /**
     * Gets the saved attributes for the attribute suffix and store
     *
     * @param string $attrkey
     * @param mixed $store
     * @return array
     */
    protected function _savedAttributes($attrkey, $store)
    {
        $path = 'brontosoftware/contact/extensions/' . $attrkey;
        $data = $this->_data->getCollection()->addPathFilter($path);
        $specificity = array();
        $savedAttributes = array();
        foreach ($data as $config) {
            if ($this->_validScope($config, $store) && $this->_moreSpecific($config, $specificity)) {
                if (array_key_exists($config->getPath(), $specificity)) {
                    list($scope, $value) = $specificity[$config->getPath()];
                    unset($savedAttributes[$value]);
                }
                $parts = explode('/', $config->getPath());
                $code = end($parts);
                $savedAttributes[$code] = $config->getValue();
                $specificity[$config->getPath()] = array($config->getScope(), $code);
            }
        }
        return $savedAttributes;
    }

    /**
     * Gets the attribute value for a data model and code
     *
     * @param mixed $value
     * @param mixed $dataModel
     * @param string $attributeCode
     * @param boolean $skipAttrCheck
     * @return string
     */
    protected function _attributeData($value, $dataModel, $attributeCode, $skipAttrCheck = false)
    {
        if ($attributeCode == 'region_id') {
            return $dataModel->getRegionCode();
        } else if ($attributeCode == 'country_id') {
            return $dataModel->getCountryId();
        } else if ($attributeCode == 'group_id') {
            return $this->_groupCache->getById($value)->getCode();
        } else if ($attributeCode == 'website_id') {
            return $this->_storeManager->getWebsite($value)->getName();
        } else if ($attributeCode == 'store_id') {
            return $this->_storeManager->getStore($value)->getName();
        }
        if (!$skipAttrCheck && method_exists($dataModel->getResource(), 'getAttribute')) {
            $attribute = $dataModel->getResource()->getAttribute($attributeCode);
            switch ($attribute->getFrontendInput()) {
                case 'select':
                    $value = $attribute->getSource()->getOptionText($value);
                    if ($value === false) {
                        return '';
                    }
                    return $value;
                case 'date':
                case 'datetime':
                    if (empty($value)) {
                        return '';
                    }
                    return $this->_formatDate($value);
                case 'multiselect':
                    $values = array();
                    if (!is_array($value)) {
                        $value = explode(',', $value);
                    }
                    if (!is_array($value)) {
                        $value = array($value);
                    }
                    $source = $attribute->getSource();
                    foreach ($value as $val) {
                        $values[] = $source->getOptionText($val);
                    }
                    return implode(',', $values);
                default:
                    return $value;
            }
        } else {
            // Exists in the flat order case
            switch ($attributeCode) {
                case 'dob':
                    if (empty($value)) {
                        return '';
                    }
                    return $this->_formatDate($value);
                default:
                    return $value;
            }
        }
    }

    /**
     * Formats a date like value
     *
     * @param string $value
     * @return string
     */
    protected function _formatDate($value)
    {
        return date('c', strtotime($value));
    }
}
