<?php
/**
 * This file was generated by the ConvertToLegacy class in bronto-legacy.
 * The purpose of the conversion was to maintain PSR-0 compliance while
 * the main development focuses on modern styles found in PSR-4.
 *
 * For the original:
 * @see src/Bronto/Magento/Browse/Event/Source.php
 */

class Brontosoftware_Magento_Browse_Event_Source implements Brontosoftware_Magento_Connector_Event_SourceInterface, Brontosoftware_Magento_Connector_Event_ContextProviderInterface
{
    protected $_settings;
    protected $_connector;

    /**
     * @param Brontosoftware_Magento_Browse_SettingsInterface $settings
     * @param Brontosoftware_Magento_Connector_SettingsInterface $connector
     */
    public function __construct(
        Brontosoftware_Magento_Browse_SettingsInterface $settings,
        Brontosoftware_Magento_Connector_SettingsInterface $connector
    ) {
        $this->_settings = $settings;
        $this->_connector = $connector;
    }

    /**
     * @see parent
     */
    public function create($browse)
    {
        return $this->_settings->createContext($browse);
    }

    /**
     * @see parent
     */
    public function getEventType()
    {
        return 'browse';
    }

    /**
     * @see parent
     */
    public function action($browse)
    {
        return 'add';
    }

    /**
     * @see parent
     */
    public function transform($browse)
    {
        if (!$browse->hasContext()) {
            $context = $this->_settings->createContext($browse);
        } else {
            $context = $browse->getContext();
        }
        $events = array();
        $eventDate = date('c', $this->_default($context, 'timestamp', time()));
        $siteId = $this->_settings->getSiteId('store', $context['store_id']);
        $siteHash = $this->_connector->getSiteId('store', $context['store_id']);
        if (array_key_exists('customer_email', $context)) {
            $events[] = array(
                'siteId' => $siteId,
                'siteHash' => $siteHash,
                'customerId' => $context['customer_id'],
                'eventType' => 'EMAIL',
                'eventDate' => $eventDate,
                'value' => $context['customer_email'],
                'url' => $this->_default($context, 'url', null)
            );
        }
        $events[] = array(
            'siteId' => $siteId,
            'siteHash' => $siteHash,
            'customerId' => $context['customer_id'],
            'eventType' => $this->_default($context, 'event_type', 'VIEW'),
            'eventTypeValue' => $this->_default($context, 'event_type_value', null),
            'eventDate' => $eventDate,
            'value' => $this->_default($context, 'value', null),
            'url' => $this->_default($context, 'url', null)
        );
        return array('events' => $events);
    }

    /**
     * Gets the value out of the map or default to defaultValue
     *
     * @param array $context
     * @param string $keyName
     * @param string $defaultValue
     * @return string
     */
    protected function _default($context, $keyName, $defaultValue)
    {
        if (array_key_exists($keyName, $context)) {
            return $context[$keyName];
        }
        return $defaultValue;
    }
}
